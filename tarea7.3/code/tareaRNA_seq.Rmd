---
title: "TareaRNA_seq"
author: "Miguel Amaro"
date: "4/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Preliminares
Definir los directorios de entrada y de salida.

```{r}
input_dir  <- file.path("..","count")
output_pseudo <- file.path("..","diff_expr", "pseudocounts") 
output_histogram <- file.path("..","diff_expr", "histograms") 
output_pvalue_fdr <- file.path("..","diff_expr", "pvalue_fdr") 
output_table <- file.path("..","diff_expr", "tables")
```

Comprobar si existe el directorio de entrada y crear los directorios de salida.

```{r}
if(!file.exists(input_dir)){
  stop("Data directory doesn't exist: ", input_dir)
}
if(!file.exists(output_pseudo)){
  dir.create(output_pseudo, mode = "0755", recursive=T)
}
if(!file.exists(output_histogram)){
  dir.create(output_histogram, mode = "0755", recursive=T)
}
if(!file.exists(output_pvalue_fdr)){
  dir.create(output_pvalue_fdr, mode = "0755", recursive=T)
}
if(!file.exists(output_table)){
  dir.create(output_table, mode = "0755", recursive=T)
}
```

#### Cargar y procesar los datos de entrada

```{r}
library(edgeR)
```

Leer datos de entrada y asignar nombres a las columnas

```{r}
wild_p <- read.delim(file=file.path(input_dir, "MW001_P.count"), sep="\t", header = F, check=F); colnames(wild_p) <- c("Gen_ID", "Count")
wild_b <- read.delim(file=file.path(input_dir, "MW001_B3.count"), sep="\t", header = F, check=F); colnames(wild_b) <- c("Gen_ID", "Count")
mut_p <- read.delim(file=file.path(input_dir, "0446_P.count"), sep="\t", header = F, check=F); colnames(mut_p) <- c("Gen_ID", "Count")
mut_b <- read.delim(file=file.path(input_dir, "0446_B3.count"), sep="\t", header = F, check=F); colnames(mut_b) <- c("Gen_ID", "Count")
```

Juntar los cuatro sets de datos

```{r}
rawcounts <- data.frame(wild_p$Gen_ID, WildType_P = wild_p$Count, WildType_B = wild_b$Count, Mutant_P = mut_p$Count, Mutant_B = mut_b$Count, row.names = 1)
```

Calcular RPKM

```{r}
rpkm <- cpm(rawcounts)
```

Remover las filas que no será utilizadas así como los genes con RPKM menores que 1 en tres de las cuatro librerías.

```{r}
to_remove <- rownames(rawcounts) %in% c("__no_feature","__ambiguous","__too_low_aQual","__not_aligned","__alignment_not_unique")
keep <- rowSums(rpkm > 1) >= 3 & !to_remove
rawcounts <- rawcounts[keep,]
```

#### Expresión diferencial para medios de cultivo

Crear vector con el que se agrupará a las muestras de acuerdo con el medio de cultivo en el que se desarrollaron

```{r}
group_culture <- c("planctonic","biofilm","planctonic","biofilm")
```

Crear objeto DGE con el cual se realizarán los cálculos para identificar los genes expresados diferencialmente.

```{r}
dge_culture <- DGEList(counts = rawcounts, group = group_culture)
```

Se calculó el factor de normalización, el cuál se usó posteriormente para normalizar los conteos de acuerdo con el tamaño de cada librería.

```{r}
dge_culture <- calcNormFactors(dge_culture)
```

Se estimaron dos valores de dispersión: uno para cada gen y otro para cada librería, los cuales se utilizaron posteriormente para las pruebas estadísticas.

```{r}
dge_culture <- estimateCommonDisp(dge_culture)
dge_culture <- estimateTagwiseDisp(dge_culture)
```

Se realizó la prueba de expresión diferencial, la cual utiliza un test exacto, que asume que los conteos siguen una distribución binomial negativa.

```{r}
de_culture <- exactTest(dge_culture, pair = c("planctonic","biofilm"))
```

Se obtuvo una tabla resumen de los resultados del test de expresión diferencial así como los ID de los genes que resultaron expresados diferencialmente.

```{r}
results_culture <- topTags(de_culture, n = nrow(dge_culture)) 
results_culture <- results_culture$table
ids_culture <- rownames(results_culture[results_culture$FDR < 0.1,])
```

#### Expresión diferencial para cada genotipo
Se creó un set de datos que no consideraba los genes expresados diferencialmente por medio de cultivo.

```{r}
rawcounts_genotype <- rawcounts[!rownames(rawcounts) %in% ids_culture,]
```

Posteriormente se realizaron los mismos pasos que en la sección de expresión diferencial por medio de cultivo.

```{r}
group_genotype <- c("wildtype","wildtype","mutant","mutant")
dge_genotype <- DGEList(counts = rawcounts_genotype, group = group_genotype)
dge_genotype <- calcNormFactors(dge_genotype)
dge_genotype <- estimateCommonDisp(dge_genotype)
dge_genotype <- estimateTagwiseDisp(dge_genotype)
de_genotype <- exactTest(dge_genotype, pair = c("wildtype","mutant"))
results_genotype <- topTags(de_genotype, n = nrow(de_genotype))
results_genotype <- results_genotype$table
ids_genotype <- rownames(results_genotype[results_genotype$FDR < 0.1,])
```

#### Resultados

Se definieron vectores booleanos que, a partir del set completo de datos, etiquete a los genes que presentaron expresión diferencial y los que no, tanto por genotipo como por medio de cultivo.

```{r}
de_genes_culture  <- rownames(rawcounts) %in% ids_culture
de_genes_genotype <- rownames(rawcounts) %in% ids_genotype
```

Se obtuvieron los pseudoconteos y se transformaron a escala logarítmica. Estos valores corresponden a los conteos normalizados por el tamaño de cada librería y fueron calculados en la etapa donde se aplicó la función ‘exactTest’.

```{r}
pseudocounts <- data.frame(rownames(rawcounts), WildType_P = log10(dge_culture$pseudo.counts[,1]), WildType_B = log10(dge_culture$pseudo.counts[,2]), Mutant_P =  log10(dge_culture$pseudo.counts[,3]), Mutant_B = log10(dge_culture$pseudo.counts[,4]), DE_C = de_genes_culture, DE_G = de_genes_genotype, row.names = 1)
```

Se graficaron los pseudoconteos para cada gen y se marcaron con color diferente aquellos que estuvieron diferencialmente expresados.

##### Por medio de cultivo
```{r}
p<-plot(pseudocounts$WildType_P, pseudocounts$WildType_B, col = ifelse(pseudocounts$DE_C, "red", "blue"), main = "Wild Type", xlab = "Planctonic", ylab = "Biofilm", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
abline(lsfit(pseudocounts$WildType_P, pseudocounts$WildType_B), col = "black")
q<-plot(pseudocounts$Mutant_P, pseudocounts$Mutant_B, col = ifelse(pseudocounts$DE_C, "red", "blue"), main = "Mutant", xlab = "Planctonic", ylab =  "Biofilm", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
abline(lsfit(pseudocounts$Mutant_P, pseudocounts$Mutant_B), col = "black")
```

##### Por genotipo

```{r}
r<-plot(pseudocounts$WildType_P, pseudocounts$Mutant_P, col = ifelse(pseudocounts$DE_G, "red", "blue"), main = "Planctonic", xlab = "Wild Type", ylab = "Mutant", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
abline(lsfit(pseudocounts$WildType_P, pseudocounts$Mutant_P), col = "black")
s<-plot(pseudocounts$WildType_B, pseudocounts$Mutant_B, col = ifelse(pseudocounts$DE_G, "red", "blue"), main = "Biofilm", xlab = "Wild Type", ylab = "Mutant", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
abline(lsfit(pseudocounts$WildType_B, pseudocounts$Mutant_B), col = "black")
```

##### Histograma de valores P
```{r}
t<-hist(x = results_culture$PValue, col = "skyblue", border = "blue", main = "Culture", xlab = "P-value", ylab = "Frequency", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2)
u<-hist(x = results_genotype$PValue, col = "skyblue", border = "blue", main = "Genotype", xlab = "P-value", ylab = "Frequency", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2)
```

##### Valores P vs. FDR

```{r}
v<-plot(results_culture$PValue, results_culture$FDR, col = "blue", main = "Culture", xlab = "P-value", ylab = "FDR", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
w<-plot(results_genotype$PValue, results_genotype$FDR, col = "blue", main = "Genotype", xlab = "P-value", ylab = "FDR", cex.main = 1.3, cex.lab = 1.3, cex.axis = 1.2, las = 01)
```


